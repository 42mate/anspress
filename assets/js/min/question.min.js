!function(a){AnsPress.models.Action=Backbone.Model.extend({defaults:{cb:"",post_id:"",title:"",label:"",query:"",active:!1,header:!1,href:"#",count:""}}),AnsPress.collections.Actions=Backbone.Collection.extend({model:AnsPress.models.Action}),AnsPress.views.Action=Backbone.View.extend({id:function(){return this.postID},className:function(){var a="";return this.model.get("header")&&(a+=" ap-dropdown-header"),this.model.get("active")&&(a+=" active"),a},tagName:"li",template:'<# if(!header){ #><a href="{{href}}" title="{{title}}">{{label}}<# if(count){ #><b>{{count}}</b><# } #></a><# } else { #>{{label}}<# } #>',initialize:function(a){this.model=a.model,this.postID=a.postID,this.model.on("change",this.render,this)},events:{"click a":"triggerAction"},render:function(){var a=_.template(this.template);return this.$el.html(a(this.model.toJSON())),this.$el.attr("class",this.className()),this},triggerAction:function(a){a.preventDefault();var b=this;AnsPress.showLoading(a.target);var c=this.model.get("cb"),d=b.model.get("query");d.ap_ajax_action="action_"+c,AnsPress.ajax({data:d,success:function(d){AnsPress.hideLoading(a.target),d.success&&"status"==c&&AnsPress.trigger("changedPostStatus",{data:d,action:b.model}),d.action&&b.model.set(d.action),d.postMessage&&b.renderPostMessage(d.postMessage)}})},renderPostMessage:function(b){_.isEmpty(b)?a("#post-"+this.postID).find("post-message").html(""):a("#post-"+this.postID).find("post-message").html(b)}}),AnsPress.views.Actions=Backbone.View.extend({id:function(){return this.postID},tagName:"ul",className:"ap-actions",initialize:function(a){this.model=a.model,this.postID=a.postID,AnsPress.on("changedPostStatus",this.postStatusChanged,this)},renderItem:function(a){var b=new AnsPress.views.Action({model:a,postID:this.postID});this.$el.append(b.render().$el)},render:function(){var a=this;return this.model.each(function(b){a.renderItem(b)}),this},postStatusChanged:function(b){a("#post-"+this.postID).removeClass(function(){return this.className.split(" ").filter(function(a){return a.match(/status-/)}).join(" ")}),a("#post-"+this.postID).addClass("status-"+b.data.newStatus);var c=this.model.where({cb:"status",active:!0});c.forEach(function(a){a.set({active:!1})})}}),AnsPress.models.Post=Backbone.Model.extend({idAttribute:"ID",defaults:{actionsLoaded:!1,hideSelect:"",status:""}}),AnsPress.views.Post=Backbone.View.extend({idAttribute:"ID",templateId:"answer",tagName:"div",id:function(){return"post-"+this.model.get("ID")},initialize:function(a){this.model.on("change:vote",this.voteUpdate,this),this.model.on("change:hideSelect",this.selectToggle,this)},events:{"click [ap-vote] > a":"voteClicked",'click [ap="actiontoggle"]':"postActions",'click [ap="select_answer"]':"selectAnswer"},voteClicked:function(b){if(b.preventDefault(),!a(b.target).is(".disable")){self=this;var c=a(b.target).is(".vote-up")?"vote_up":"vote_down",d=_.clone(self.model.get("vote")),e=_.clone(d);"vote_up"===c?e.net="vote_up"===e.active?e.net-1:e.net+1:e.net="vote_down"===e.active?e.net+1:e.net-1,self.model.set("vote",e);var f=a.parseJSON(a(b.target).parent().attr("ap-vote"));f.ap_ajax_action="vote",f.type=c,AnsPress.ajax({data:f,success:function(a){a.success&&_.isObject(a.voteData)?self.model.set("vote",a.voteData):self.model.set("vote",d)}})}},voteUpdate:function(a){var b=this;this.$el.find('[ap="votes_net"]').text(this.model.get("vote").net),_.each(["up","down"],function(a){b.$el.find(".vote-"+a).removeClass("voted disable").addClass(b.voteClass("vote_"+a))})},voteClass:function(a){a=a||"vote_up";var b=this.model.get("vote").active,c="";return"vote_up"===b&&"vote_up"===a&&(c="active"),"vote_down"===b&&"vote_down"===a&&(c="active"),a!==b&&""!==b&&(c+=" disable"),c+" prist"},render:function(){var b=this.$el.find("[ap-vote]").attr("ap-vote");return this.model.set("vote",a.parseJSON(b),{silent:!0}),this},postActions:function(b){var c=this,d=a.parseJSON(a(b.target).attr("ap-query"));d.ap_ajax_action="post_actions",this.model.get("actionsLoaded")||AnsPress.ajax({data:d,success:function(d){AnsPress.hideLoading(b.target),a(b.target).addClass("loaded");var e=new AnsPress.collections.Actions(d.actions),f=new AnsPress.views.Actions({model:e,postID:c.model.get("ID")});c.$el.find("post-actions .ap-actions").html(f.render().$el)}})},selectAnswer:function(b){b.preventDefault();var c=this,d=a.parseJSON(a(b.target).attr("ap-query"));d.ap_ajax_action="toggle_best_answer",AnsPress.ajax({data:d,success:function(d){AnsPress.hideLoading(b.target),d.success&&("selected"===d.action?(c.$el.addClass("best-answer"),a(b.target).addClass("active").text(d.label),AnsPress.trigger("answerToggle",[c.model,!0])):(c.$el.removeClass("best-answer"),a(b.target).removeClass("active").text(d.label),AnsPress.trigger("answerToggle",[c.model,!1])))}})},selectToggle:function(){this.model.get("hideSelect")?this.$el.find('[ap="select_answer"]').addClass("hide"):this.$el.find('[ap="select_answer"]').removeClass("hide")}}),AnsPress.collections.Posts=Backbone.Collection.extend({model:AnsPress.models.Post,initialize:function(){var b=[];a('[ap="question"],[ap="answer"]').each(function(c){b.push({ID:a(this).attr("ap-id")})}),this.add(b)}}),AnsPress.views.SingleQuestion=Backbone.View.extend({initialize:function(){this.model.on("add",this.renderItem,this),AnsPress.on("answerToggle",this.answerToggle,this)},events:{'click [ap="loadEditor"]':"loadEditor",'submit [ap="answerForm"]':"answerForm"},renderItem:function(a){var b=new AnsPress.views.Post({model:a,el:"#post-"+a.get("ID")});b.render()},render:function(){var a=this;return this.model.each(function(b){a.renderItem(b)}),a},loadEditor:function(b){AnsPress.showLoading(b.target),AnsPress.ajax({data:a(b.target).attr("ap-query"),success:function(c){AnsPress.hideLoading(b.target),a(".ap-field-description").html(c),a(b.target).closest(".ap-minimal-editor").removeClass("ap-minimal-editor")}})},answerForm:function(b){var c=this;return AnsPress.showLoading(a(b.target).find(".ap-btn-submit")),a(b.target).find(".have-error").removeClass("have-error"),a(b.target).find(".error").remove(),AnsPress.ajax({data:a(b.target).serialize(),success:function(d){return d.redirect?void(window.location=d.redirect):(AnsPress.hideLoading(a(b.target).find(".ap-btn-submit")),AnsPress.uploader&&AnsPress.uploader.splice(),d.success&&(a("ap-answers-w").show(),a("#description").val(""),"undefined"!=typeof tinyMCE&&d.success&&tinyMCE.activeEditor.setContent(""),a("ap-answers").append(a(d.html).hide()),a(d.div_id).slideDown(500),c.model.add({ID:d.ID}),a("[ap-answecount-text]").text(d.answers_count.text)),void(d.errors&&_.each(d.errors,function(b,c){a(".ap-field-"+c).addClass("have-error"),"description"===c&&a(".ap-field-ap_upload").length>0&&(c="ap_upload"),a(".ap-field-"+c).append('<span class="error">'+b+"</span>")})))}}),!1},answerToggle:function(a){this.model.forEach(function(b,c){a[0]!==b&&b.set("hideSelect",a[1])})}}),a('[ap="actiontoggle"]').click(function(){a(this).is(".checked")||a(this).is(".loaded")||AnsPress.showLoading(this),a(this).toggleClass("checked")});var b=new AnsPress.collections.Posts,c=new AnsPress.views.SingleQuestion({model:b,el:"#anspress"});c.render()}(jQuery);