!function(a){AnsPress.loadTemplate("notifications"),AnsPress.models.Notification=Backbone.Model.extend({idAttribute:"ID",defaults:{ID:"",verb:"",verb_label:"",icon:"",avatar:"",hide_actor:"",actor:"",ref_title:"",ref_type:"",points:"",date:"",permalink:"",seen:""}}),AnsPress.collections.Notifications=Backbone.Collection.extend({model:AnsPress.models.Notification}),AnsPress.views.Notification=Backbone.View.extend({id:function(){return"noti-"+this.model.id},template:AnsPress.getTemplate("notification"),initialize:function(a){this.model=a.model},render:function(){var a=_.template(this.template());return this.$el.html(a(this.model.toJSON())),this}}),AnsPress.views.Notifications=Backbone.View.extend({template:AnsPress.getTemplate("notifications"),initialize:function(a){this.model=a.model,this.mark_args=a.mark_args,this.total=a.total,this.listenTo(this.model,"add",this.newNoti),this.listenTo(AnsPress,"notificationAllRead",this.allRead)},renderItem:function(a){this.$el.parent().addClass("have-comments");var b=new AnsPress.views.Notification({model:a});return this.$el.find(".scroll-wrap").append(b.render().$el),b},render:function(){var a=this,b=_.template(this.template());return this.$el.html(b({mark_args:this.mark_args,total:this.total})),this.model.length>0&&this.model.each(function(b){a.renderItem(b)}),this},newNoti:function(a){this.renderItem(a)},allRead:function(){this.total=0,this.model.each(function(a){a.set("seen",1)}),this.render()}});var b=Backbone.Router.extend({routes:{apNotifications:"notiRoute"},dpPos:function(a,b){var c=b.offset();c.top=c.top+b.height(),c.left=c.left-a.width()+b.width(),a.css(c)},notiRoute:function(b,c){var d=this;AnsPress.ajax({data:ajaxurl+"?action=ap_ajax&ap_ajax_action=get_notifications",success:function(b){var c=a(".anspress-menu-notifications"),e=a("#noti-dp");if(b.success){if(0==e.length){var f=a('<div id="noti-dp"></div>');a("body").append(f),d.dpPos(f,c)}else e.show();var g=new AnsPress.collections.Notifications(b.notifications),h=new AnsPress.views.Notifications({model:g,mark_args:b.mark_args,total:b.total});a("#noti-dp").html(h.render().$el)}}})}});a(document).ready(function(){new b;Backbone.history.start(),a(".anspress-menu-notifications a").click(function(){"#"===a(this).attr("href")?(a(this).attr("href","#apNotifications"),a("#noti-dp").hide()):a(this).attr("href","#")}),a(document).mouseup(function(b){var c=a("#noti-dp");c.is(b.target)||0!==c.has(b.target).length||(c.hide(),Backbone.history.navigate("",{trigger:!0}))})})}(jQuery);