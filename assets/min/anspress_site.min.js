window.AnsPress=_.extend({models:{},views:{},collections:{},loadTemplate:function(a,b){var c=this;0===jQuery("#apTemplate-"+a).length?(jQuery('<script id="apTemplate-'+a+'" type="text/html"></script>').appendTo("body"),jQuery.get(apTemplateUrl+"/"+a+".html",function(d){jQuery("#apTemplate-"+a).html(d),c.trigger("templateLoaded-"+a,d),b&&b(d)})):c.trigger("templateLoaded-"+a,jQuery("#apTemplate-"+a).html())},isJSONString:function(a){try{return JSON.parse(a)}catch(a){return!1}},ajaxResponse:function(a){if(a=jQuery(a),"undefined"==typeof a.filter("#ap-response"))return console.log("Not a valid AnsPress ajax response."),{};var b=this.isJSONString(a.filter("#ap-response").html());return b&&"undefined"!==b&&_.isObject(b)?b:{}},ajax:function(a){var b=this;a=_.defaults(a,{url:ajaxurl,method:"POST"}),_.isObject(a.data)&&(a.data=jQuery.param(a.data)),a.data="action=ap_ajax&"+a.data;var c=a.success;return delete a.success,a.success=function(d){var e=a.context||null,f=b.ajaxResponse(d);f.snackbar&&AnsPress.trigger("snackbar",f),"function"==typeof c&&(d=jQuery.isEmptyObject(f)?d:f,c(d,e))},jQuery.ajax(a)},uniqueId:function(){return jQuery(".ap-uid").length},showLoading:function(a){AnsPress.hideLoading(a);var b=jQuery(a).data("loadclass")||"",c=this.uniqueId(),d=jQuery('<div class="ap-loading-icon ap-uid '+b+'" id="apuid-'+c+'"></div>');jQuery("body").append(d);var e=jQuery(a).offset(),f=jQuery(a).outerHeight(),g=jQuery(a).outerWidth();return d.css({top:e.top,left:e.left,height:f,width:g}),jQuery(a).data("loading","#apuid-"+c),"#apuid-"+c},hideLoading:function(a){"all"==a?jQuery(".ap-loading-icon").hide():jQuery(jQuery(a).data("loading")).hide()}},Backbone.Events),_.templateSettings={evaluate:/<#([\s\S]+?)#>/g,interpolate:/\{\{\{([\s\S]+?)\}\}\}/g,escape:/\{\{([^\}]+?)\}\}(?!\})/g},function(a){AnsPress.models.Post=Backbone.Model.extend({idAttribute:"ID",defaults:{actions:[{id:"comment",label:"Comment"},{id:"select",label:"Select"},{id:"edit",label:"Edit"},{id:"status",label:"Status",sub:[{id:"publish",label:"Publish"},{id:"trash",label:"Trash"},{id:"private",label:"Private"},{id:"moderate",label:"Moderate"}]}]}}),AnsPress.views.Post=Backbone.View.extend({idAttribute:"ID",templateId:"answer",tagName:"div",id:function(){return"post-"+this.model.get("ID")},initialize:function(a){this.model.on("change:vote",this.voteUpdate,this)},events:{"click [ap-vote] > a":"voteClicked"},voteClicked:function(b){if(b.preventDefault(),!a(b.target).is(".disable")){self=this;var c=a(b.target).is(".vote-up")?"vote_up":"vote_down",d=_.clone(self.model.get("vote"));"vote_up"===c?d.net="vote_up"===d.active?d.net-1:d.net+1:d.net="vote_down"===d.active?d.net+1:d.net-1,self.model.set("vote",d);var e=a.parseJSON(a(b.target).parent().attr("ap-vote"));e.ap_ajax_action="vote",e.type=c,AnsPress.ajax({data:e,success:function(a){_.isObject(a.voteData)&&self.model.set("vote",a.voteData)}})}},voteUpdate:function(a){var b=this;this.$el.find('[ap="votes_net"]').text(this.model.get("vote").net),_.each(["up","down"],function(a){b.$el.find(".vote-"+a).removeClass("voted disable").addClass(b.voteClass("vote_"+a))})},voteClass:function(a){a=a||"vote_up";var b=this.model.get("vote").active,c="";return"vote_up"===b&&"vote_up"===a&&(c="active"),"vote_down"===b&&"vote_down"===a&&(c="active"),a!==b&&""!==b&&(c+=" disable"),c+" prist"},render:function(){var b=this.$el.find("[ap-vote]").attr("ap-vote");return this.model.set("vote",a.parseJSON(b),{silent:!0}),this}}),AnsPress.collections.Posts=Backbone.Collection.extend({model:AnsPress.models.Post,initialize:function(){var b=[];a('[ap="question"],[ap="answer"]').each(function(c){b.push({ID:a(this).attr("ap-id")})}),this.add(b)}}),AnsPress.views.SingleQuestion=Backbone.View.extend({initialize:function(){this.model.on("add",this.renderItem,this)},events:{'click [ap="loadEditor"]':"loadEditor",'submit [ap="answerForm"]':"answerForm","submit #hidden-post-upload":"uploadForm"},renderItem:function(a){var b=new AnsPress.views.Post({model:a,el:"#post-"+a.get("ID")});b.render()},render:function(){var a=this;return this.model.each(function(b){a.renderItem(b)}),a},loadEditor:function(b){AnsPress.showLoading(b.target),AnsPress.ajax({data:a(b.target).attr("ap-query"),success:function(c){AnsPress.hideLoading(b.target),a(".ap-field-description").html(c),a(b.target).closest(".ap-minimal-editor").removeClass("ap-minimal-editor")}})},answerForm:function(b){var c=this;return AnsPress.showLoading(a(b.target).find(".ap-btn-submit")),a(b.target).find(".have-error").removeClass("have-error"),a(b.target).find(".error").remove(),AnsPress.ajax({data:a(b.target).serialize(),success:function(d){AnsPress.hideLoading(a(b.target).find(".ap-btn-submit")),d.success&&(a("#description").val(""),"undefined"!=typeof tinyMCE&&d.success&&tinyMCE.activeEditor.setContent(""),a("#answers").append(a(d.html).hide()),a(d.div_id).slideDown(500),c.model.add({ID:d.ID})),d.errors&&_.each(d.errors,function(b,c){a(".ap-field-"+c).addClass("have-error"),"description"===c&&a(".ap-field-ap_upload").length>0&&(c="ap_upload"),a(".ap-field-"+c).append('<span class="error">'+b+"</span>")})}}),!1},uploadForm:function(b){a('[data-action="ap_post_upload_field"]').closest(".ap-upload-o");return a(b.target).ajaxSubmit({beforeSubmit:function(){AnsPress.showLoading(b.target)},success:function(c){if(AnsPress.hideLoading(b.target),c=a(c),c=JSON.parse(c.filter("#ap-response").html()),a("body").trigger("postUploadForm",c),"undefined"!=typeof c.url){if(c.mime.indexOf("image")>-1)var d='<img src="'+c.url+'" />';var d='<span id="'+c.attachment_id+'"><i class="apicon-cloud-upload"></i><a href="'+c.url+'">'+c.name+'</a><i class="close" data-action="ajax_btn" data-query="delete_attachment::'+ap_nonce+"::"+c.attachment_id+'">&times;</i></span>';a(d).appendTo("#ap-upload-list"),a(".ap-post-upload-form").append('<input type="hidden" name="attachment_ids[]" value="'+c.attachment_id+'" />')}},url:ajaxurl,type:"POST",uploadProgress:function(a,b,c,d){var e=d+"%";console.log(e)}}),!1}}),AnsPress.views.Snackbar=Backbone.View.extend({id:"ap-snackbar",template:'<div class="ap-snackbar<# if(success){ #> success<# } #>">{{message}}</div>',hover:!1,initialize:function(){AnsPress.on("snackbar",this.show,this)},events:{mouseover:"toggleHover",mouseout:"toggleHover"},show:function(a){var b=this;this.data=a.snackbar,this.data.success=a.success,this.$el.removeClass("snackbar-show"),this.render(),setTimeout(function(){b.$el.addClass("snackbar-show")},0),this.hide()},toggleHover:function(){clearTimeout(this.hoveTimeOut),this.hover=!this.hover,this.hover||this.hide()},hide:function(){var a=this;a.hover||(this.hoveTimeOut=setTimeout(function(){a.$el.removeClass("snackbar-show")},2e3))},render:function(){if(this.data){var a=_.template(this.template);this.$el.html(a(this.data))}return this}})}(jQuery);var apposts=new AnsPress.collections.Posts,singleQuestionView=new AnsPress.views.SingleQuestion({model:apposts,el:"#ap-single"});singleQuestionView.render();var apSnackbarView=new AnsPress.views.Snackbar;jQuery("body").append(apSnackbarView.render().$el);